<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Arch Linux - Surface Book 3 | Wilderness Downtown</title>
<link rel=canonical href=https://julianyap.com/pages/2024-04-04-1712257725/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://julianyap.com/pages/2024-04-04-1712257725/"><meta property="og:site_name" content="Wilderness Downtown"><meta property="og:title" content="Arch Linux - Surface Book 3"><meta property="og:description" content="Introduction I have installed Arch Linux on a Microsoft Surface Book 3 to use as my “focus” machine. This page outlines some set up items and other issues.
Most everything works out of the box except the cameras, which I’ve disabled in the BIOS.
Suspend only supports suspend to RAM so I use Hibernation.
This is not a recommended laptop for running Linux.
Introduction Common issues and general set up Visual Studio Code hangs on launch Toshy - Mac key bindings SSH Agent Jetbrains Mono, Apple and Microsoft fonts Avahi Brother HL-3170CDW printer Hibernate Nvidia GPU Resume from Hibernate has the wrong time Other packages Unresolved issues i915 0000:00:02."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="pages"><meta property="article:published_time" content="2024-04-04T12:08:45-07:00"><meta property="article:modified_time" content="2024-04-04T12:08:45-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Arch Linux - Surface Book 3"><meta name=twitter:description content="Introduction I have installed Arch Linux on a Microsoft Surface Book 3 to use as my “focus” machine. This page outlines some set up items and other issues.
Most everything works out of the box except the cameras, which I’ve disabled in the BIOS.
Suspend only supports suspend to RAM so I use Hibernation.
This is not a recommended laptop for running Linux.
Introduction Common issues and general set up Visual Studio Code hangs on launch Toshy - Mac key bindings SSH Agent Jetbrains Mono, Apple and Microsoft fonts Avahi Brother HL-3170CDW printer Hibernate Nvidia GPU Resume from Hibernate has the wrong time Other packages Unresolved issues i915 0000:00:02."><link rel=stylesheet href=https://julianyap.com/css/styles.3293cde0ba45207bc30ea388dcd0b13853ce2a765f7062b3b64049d144d97ff3ebebfe523de731ae740d355ea236be1fb55794d29a7f84012e98e293c9da881c.css integrity="sha512-MpPN4LpFIHvDDqOI3NCxOFPOKnZfcGKztkBJ0UTZf/Pr6/5SPecxrnQNNV6iNr4ftVeU0pp/hAEumOKTydqIHA=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://julianyap.com/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://julianyap.com/><div id=logo><svg viewBox="0 0 512 512"><path d="M284.3 11.7c-15.6-15.6-40.9-15.6-56.6.0l-216 216c-15.6 15.6-15.6 40.9.0 56.6l216 216c15.6 15.6 40.9 15.6 56.6.0l216-216c15.6-15.6 15.6-40.9.0-56.6l-216-216z" fill="#980004"/></svg></div><div id=title><h1>Wilderness Downtown</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/posts>Posts</a></li><li><a href=/pages>Pages</a></li><li><a href=/about>About</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=content itemprop=articleBody><h2 id=introduction>Introduction</h2><p>I have installed Arch Linux on a Microsoft Surface Book 3 to use as my &ldquo;focus&rdquo; machine. This page outlines some set up items and other issues.</p><p>Most everything <a href=https://github.com/linux-surface/linux-surface/wiki/Supported-Devices-and-Features#surface-books-and-surface-laptop-studio>works out of the box</a> except the cameras, which I&rsquo;ve disabled in the BIOS.</p><p><a href=#suspend>Suspend</a> only supports suspend to RAM so I use Hibernation.</p><p>This is <em>not</em> a recommended laptop for running Linux.</p><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#common-issues-and-general-set-up>Common issues and general set up</a><ul><li><a href=#visual-studio-code-hangs-on-launch>Visual Studio Code hangs on launch</a></li><li><a href=#toshy---mac-key-bindings>Toshy - Mac key bindings</a></li><li><a href=#ssh-agent>SSH Agent</a></li><li><a href=#jetbrains-mono-apple-and-microsoft-fonts>Jetbrains Mono, Apple and Microsoft fonts</a></li><li><a href=#avahi>Avahi</a></li><li><a href=#brother-hl-3170cdw-printer>Brother HL-3170CDW printer</a></li><li><a href=#hibernate>Hibernate</a></li><li><a href=#nvidia-gpu>Nvidia GPU</a></li><li><a href=#resume-from-hibernate-has-the-wrong-time>Resume from Hibernate has the wrong time</a></li><li><a href=#other-packages>Other packages</a></li></ul></li><li><a href=#unresolved-issues>Unresolved issues</a><ul><li><a href=#i915-000000020-drm-error-link-training-unsuccessful>i915 0000:00:02.0: [drm] <em>ERROR</em> Link Training Unsuccessful</a></li><li><a href=#suspend>Suspend - Only support Suspend to RAM/Idle</a></li></ul></li></ul></nav><h2 id=common-issues-and-general-set-up>Common issues and general set up</h2><h3 id=visual-studio-code-hangs-on-launch>Visual Studio Code hangs on launch</h3><p>Had <a href=https://github.com/microsoft/vscode/issues/188397#issuecomment-2033053045>this issue</a>.</p><p>Work around add to ~/.vscode-oss/argv.json</p><pre tabindex=0><code>        &#34;password-store&#34;: &#34;basic&#34;
</code></pre><h3 id=toshy---mac-key-bindings>Toshy - Mac key bindings</h3><p>Installed <a href=https://github.com/RedBearAK/toshy>Toshy</a> because apparently it works better with Wayland.</p><p>Install <a href=https://github.com/xremap/xremap-gnome>xremap-gnome</a> for this to work on Wayland.</p><h3 id=ssh-agent>SSH Agent</h3><p>Add this to <code>~/.bashrc</code></p><pre tabindex=0><code># ssh-agent modified from: https://wiki.archlinux.org/title/SSH_keys#ssh-agent
if ! pgrep -u &#34;$USER&#34; ssh-agent &gt; /dev/null; then
    ssh-agent &gt; &#34;$XDG_RUNTIME_DIR/ssh-agent.env&#34;
fi
if [[ ! -f &#34;$SSH_AUTH_SOCK&#34; ]]; then
    source &#34;$XDG_RUNTIME_DIR/ssh-agent.env&#34; &gt;/dev/null
fi
</code></pre><p>Realized that the timeout is set to 1 hour with the &ldquo;-t 1h&rdquo; flag. I removed this since it was annoying.</p><h3 id=jetbrains-mono-apple-and-microsoft-fonts>Jetbrains Mono, Apple and Microsoft fonts</h3><p>Arch has this</p><pre tabindex=0><code>sudo pacman -S ttf-jetbrains-mono apple-fonts ttf-ms-win11-auto
</code></pre><p>Set the default for Visual Studio Code: <a href=https://stackoverflow.com/questions/59776906/how-do-i-change-vs-code-settings-to-use-jetbrains-mono-font>https://stackoverflow.com/questions/59776906/how-do-i-change-vs-code-settings-to-use-jetbrains-mono-font</a></p><h3 id=avahi>Avahi</h3><p>Install</p><pre tabindex=0><code>sudo pacman -S avahi nss-mdns
</code></pre><p>Enable and start</p><pre tabindex=0><code>sudo systemctl enable avahi-daemon.service
sudo systemctl start avahi-daemon.service
</code></pre><p>Enable hostname resolution. Modify line in /etc/nsswitch.conf</p><pre tabindex=0><code>hosts: mymachines mdns4_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] files myhostname dns
</code></pre><h3 id=brother-hl-3170cdw-printer>Brother HL-3170CDW printer</h3><p>Install CUPS</p><pre tabindex=0><code>sudo pacman -S cups
systemctl enable cups.service
systemctl restart cups.service
systemctl status cups.service
</code></pre><p>Install driver</p><pre tabindex=0><code>yay -S brother-hl3170cdw
</code></pre><p>Add printer via CUPS Administration http://localhost:631/admin</p><h3 id=hibernate>Hibernate</h3><p>I set up a large enough swap partition (equal to RAM size) so that extra set up like setting up a swap file offset isn&rsquo;t necessary.</p><p>The other steps are to configure the initramfs:</p><ul><li>Add &lsquo;resume&rsquo;</li><li>Regenerate initramfs</li></ul><p>Specify the kernel parameter <code>resume=${swap_device}</code>.</p><p>FROM: <a href=https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Hibernation>https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Hibernation</a></p><h3 id=nvidia-gpu>Nvidia GPU</h3><p>This comes with a GeForce GTX 1660 Ti:</p><pre tabindex=0><code>$ lspci | grep NVIDIA
02:00.0 3D controller: NVIDIA Corporation TU116M [GeForce GTX 1660 Ti Mobile] (rev a1)
</code></pre><p>With 6GB of VRAM:</p><pre tabindex=0><code>$ nvidia-smi -q -d MEMORY

==============NVSMI LOG==============

Timestamp                                 : Wed Aug 21 16:14:56 2024
Driver Version                            : 555.58.02
CUDA Version                              : 12.5

Attached GPUs                             : 1
GPU 00000000:02:00.0
    FB Memory Usage
        Total                             : 6144 MiB
        Reserved                          : 389 MiB
        Used                              : 5 MiB
        Free                              : 5751 MiB
</code></pre><p>It&rsquo;s enough to run some machine learning models.</p><p>For NVIDIA drivers with custom kernels, you need to install the <code>nvidia-dkms</code> package.
The non-DKMS ones are built specifically for Arch&rsquo;s kernel, so they won&rsquo;t load with any other kernels (not even Arch&rsquo;s LTS kernel).</p><p>I&rsquo;m finding strange keyboard issues with the base Arch kernel so I&rsquo;ve stuck with the Linux Surface kernel. The downside of the <code>nvidia-dkms</code> package is that it needs to be rebuilt (automatically) each time a new kernel is installed/upgraded, hence the term &ldquo;dynamic kernel module support&rdquo;.</p><p>More details: <a href=https://www.reddit.com/r/archlinux/comments/16iz9co/comment/k0n00uf/>https://www.reddit.com/r/archlinux/comments/16iz9co/comment/k0n00uf/</a></p><h3 id=resume-from-hibernate-has-the-wrong-time>Resume from Hibernate has the wrong time</h3><p>Resume from Hibernate suffers from clock drift so has the wrong time.</p><p>To resolve this, I set up a systemd service that runs a time synchronization command when the system wakes up. Here&rsquo;s a step-by-step approach to implement this.</p><p>First, make sure you have the systemd-timesyncd service enabled and running. This is the default time synchronization daemon for Arch Linux. If it&rsquo;s not already enabled, you can enable it with:</p><pre tabindex=0><code>sudo systemctl enable --now systemd-timesyncd.service
</code></pre><p>Create a new systemd service file:</p><pre tabindex=0><code>sudo vi /etc/systemd/system/fix-time-on-resume.service
</code></pre><p>Add the following content to the file:</p><pre tabindex=0><code>[Unit]
Description=Fix system time on resume from hibernate
After=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target

[Service]
Type=oneshot
ExecStart=/usr/bin/systemctl restart systemd-timesyncd.service

[Install]
WantedBy=suspend.target hibernate.target hybrid-sleep.target suspend-then-hibernate.target
</code></pre><p>Reload the systemd daemon to recognize the new service:</p><pre tabindex=0><code>sudo systemctl daemon-reload
</code></pre><p>Enable the new service:</p><pre tabindex=0><code>sudo systemctl enable fix-time-on-resume.service
</code></pre><p>This service automatically restarts the systemd-timesyncd service when your system resumes from hibernation, which corrects the time.</p><h3 id=other-packages>Other packages</h3><p>Some other packages I install:</p><pre tabindex=0><code>chromium
code
freetube
git
go
hugo
jq
rust
sudo
vim
</code></pre><h2 id=unresolved-issues>Unresolved issues</h2><h3 id=i915-000000020-drm-error-link-training-unsuccessful>i915 0000:00:02.0: [drm] <em>ERROR</em> Link Training Unsuccessful</h3><p>dmesg output:</p><pre tabindex=0><code>[  861.301517] i915 0000:00:02.0: [drm] *ERROR* Link Training Unsuccessful
</code></pre><p>Similar to: <a href=https://github.com/NixOS/nixpkgs/issues/36392>https://github.com/NixOS/nixpkgs/issues/36392</a></p><p>Appears to be an issue with the dock and using a USBC to Display Port cable.</p><p>Unplugging the power cable (which connects to the dock) seems to help get the external screen displaying again. Annoying workaround.</p><h3 id=suspend>Suspend - Only support Suspend to RAM/Idle</h3><p>Suspend only supports <a href=https://www.kernel.org/doc/Documentation/power/states.txt>ACPI state 0 Suspend-To-Idle</a> and eats up 20%+ of the battery life overnight.</p><p>I Hibernate my laptop which writes the state to disk so only uses less than 1% of battery life a day (normal no usage battery trickle).</p><p><a href=https://github.com/linux-surface/linux-surface/issues/1515#issuecomment-2267646335>This link</a> explains why the the laptop only supports suspend to RAM:</p><pre tabindex=0><code>Suspend-to-ram, on the other hand, is disabled by the ACPI firmware of the device. I think people have tried to enable it again in some other issue, but that requires patching of the ACPI tables (i.e., not something that we can do from the kernel/software side alone).
</code></pre></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Julian Yap</div><div class=footer-right><nav><ul><li><a href=/posts>Posts</a></li><li><a href=/pages>Pages</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>